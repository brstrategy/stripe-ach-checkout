<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
Â  <title id="pageTitle">Payment Status</title>
Â  <script src="https://js.stripe.com/v3/"></script>
Â  <style>
Â  Â  body {
Â  Â  Â  font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
Â  Â  Â  background: #f7f7f7;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: start;
Â  Â  Â  min-height: 100vh;
Â  Â  Â  margin: 0;
Â  Â  Â  padding: 40px 20px;
Â  Â  Â  text-align: center;
Â  Â  }
Â  Â  header {
Â  Â  Â  width: 100%;
Â  Â  Â  text-align: center;
Â  Â  Â  margin-bottom: 30px;
Â  Â  }
Â  Â  .logo-container {
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  align-items: center;
Â  Â  }
Â  Â  .logo-img {
Â  Â  Â  max-width: 300px;
Â  Â  Â  width: 100%;
Â  Â  Â  height: auto;
Â  Â  Â  display: block;
Â  Â  Â  margin-bottom: 15px;
Â  Â  }
Â  Â  h1 {
Â  Â  Â  color: #4CAF50;
Â  Â  }
Â  Â  .error-h1 {
Â  Â  Â  color: #D32F2F;
Â  Â  }
Â  Â  p {
Â  Â  Â  font-size: 1.2em;
Â  Â  }
Â  Â  a {
Â  Â  Â  display: inline-block;
Â  Â  Â  margin-top: 20px;
Â  Â  Â  padding: 10px 20px;
Â  Â  Â  background: #016FD0;
Â  Â  Â  color: #fff;
Â  Â  Â  text-decoration: none;
Â  Â  Â  border-radius: 5px;
Â  Â  }
Â  Â  a:hover {
Â  Â  Â  background: #0A4879;
Â  Â  }
Â  Â  #statusMessage {
Â  Â  Â  margin-top: 20px;
Â  Â  }
Â  </style>
</head>
<body>
Â  <header>
Â  Â  <div class="logo-container">
Â  Â  Â  <img src="images/logo.jpg" alt="Dorothy Cole Logo" class="logo-img" />
Â  Â  Â  <div class="main-title">Secure Payment</div>
Â  Â  </div>
Â  </header>
Â  
Â  <h1 id="mainHeading">Processing Payment...</h1>
Â  <p id="statusMessage">Please wait while we finalize your transaction.</p>
Â  <a id="homeLink" href="index.html" style="display:none;">Make Another Payment</a>
Â  
Â  <script>
Â  Â  const WORKER_URL = 'https://custom-stripe-checkout-worker.brigham.workers.dev';
Â  Â  const STRIPE_PUBLIC_KEY = 'pk_test_51RqI7CAtDFEhM4UVdqmZtq6zADc1RWJNZMQEslgTR0rJMze1MO6VTof0OOAtlwEQ9vwpZBIyEHaqLKAhmJAl6g9I00SbS1Vhts';
Â  Â  const stripe = Stripe(STRIPE_PUBLIC_KEY);

Â  Â  const urlParams = new URLSearchParams(window.location.search);
Â  Â  const sessionId = urlParams.get('session_id');
Â  Â  const mode = urlParams.get('mode');
Â  Â  const amount = urlParams.get('amount'); // Amount is in cents

Â  Â  const mainHeading = document.getElementById('mainHeading');
Â  Â  const statusMessage = document.getElementById('statusMessage');
Â  Â  const pageTitle = document.getElementById('pageTitle');
Â  Â  const homeLink = document.getElementById('homeLink');

Â  Â  // Default Success State (for mode=payment)
Â  Â  function showPaymentSuccess() {
Â  Â  Â  pageTitle.textContent = 'Payment Successful';
Â  Â  Â  mainHeading.textContent = 'Payment Successful! ðŸŽ‰';
Â  Â  Â  mainHeading.className = '';
Â  Â  Â  statusMessage.textContent = 'Thank you for your payment.';
Â  Â  Â  homeLink.style.display = 'inline-block';
Â  Â  }

Â  Â  // Error State
Â  Â  function showPaymentError(errorMsg) {
Â  Â  Â  pageTitle.textContent = 'Payment Error';
Â  Â  Â  mainHeading.textContent = 'Payment Error ðŸ˜ž';
Â  Â  Â  mainHeading.className = 'error-h1';
Â  Â  Â  statusMessage.textContent = `There was an issue processing your payment. Details: ${errorMsg}`;
Â  Â  Â  homeLink.style.display = 'inline-block';
Â  Â  }
Â  Â  
Â  Â  // Check for Setup Mode, which requires a follow-up charge
Â  Â  if (mode === 'setup' && sessionId) {
Â  Â  Â  Â  // Retrieve the Checkout Session data to get the SetupIntent ID
Â  Â  Â  Â  stripe.retrieveCheckoutSession(sessionId).then(async ({ session }) => {
Â  Â  Â  Â  Â  if (session && session.setup_intent) {
Â  Â  Â  Â  Â  Â  // Retrieve the SetupIntent to get the saved Payment Method ID
Â  Â  Â  Â  Â  Â  stripe.retrieveSetupIntent(session.setup_intent).then(async ({ setupIntent }) => {
Â  Â  Â  Â  Â  Â  Â  if (setupIntent && setupIntent.status === 'succeeded' && setupIntent.payment_method) {
Â  Â  Â  Â  Â  Â  Â  Â  // Found verified Payment Method. Now call Worker to charge it.
Â  Â  Â  Â  Â  Â  Â  Â  const customerId = session.customer;
Â  Â  Â  Â  Â  Â  Â  Â  const paymentMethodId = setupIntent.payment_method;

Â  Â  Â  Â  Â  Â  Â  Â  statusMessage.textContent = 'Saved payment method confirmed. Finalizing charge...';
                
Â  Â  Â  Â  Â  Â  Â  Â  // Call new Worker endpoint to create and confirm Payment Intent
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  const chargeRes = await fetch(`${WORKER_URL}/process-saved-payment`, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  customerId: customerId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  paymentMethodId: paymentMethodId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  amount: parseInt(amount), 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  const chargeData = await chargeRes.json();

Â  Â  Â  Â  Â  Â  Â  Â  Â  if (chargeRes.ok && chargeData.status === 'processing') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ACH payment status is usually 'processing' immediately after confirmation
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showPaymentSuccess();
Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showPaymentError(`Charge failed: ${chargeData.error || 'Unknown error'}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  showPaymentError(`Network Error during charge: ${err.message}`);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // Setup Intent failed or not succeeded
Â  Â  Â  Â  Â  Â  Â  Â  showPaymentError('Payment method setup failed or was not completed.');
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // No session or SetupIntent ID found
Â  Â  Â  Â  Â  Â  showPaymentError('Payment session data could not be retrieved.');
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  } else if (sessionId) {
Â  Â  Â  // This handles the standard 'mode: payment' success
Â  Â  Â  showPaymentSuccess();
Â  Â  } else {
Â  Â  Â  // This handles direct access to success.html without parameters
Â  Â  Â  showPaymentError('No session ID found.');
Â  Â  }
Â  </script>
</body>
</html>