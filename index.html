<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dorothy Cole - Payment</title>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    /* Your existing styles */
    body { 
      background: #FFFFFF; 
      color: #333; 
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: start; 
      min-height: 100vh; 
      margin: 0; 
      padding: 40px 20px;
    }
    header { width: 100%; text-align: center; margin-bottom: 30px; }
    .logo-container { display: flex; flex-direction: column; align-items: center; width: 100%; }
    .logo-img { max-width: 300px; width: 100%; height: auto; display: block; margin-bottom: 15px; }
    h1 { font-size: 2.5em; margin: 0; color: #0A4879; }
    .main-title { font-size: 1.5em; margin-top: 5px; color: #0A4879; }
    .container {
      background: #fff;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 400px;
      width: 100%;
      margin: 0 auto;
      box-sizing: border-box;
    }
    label { display: block; font-weight: 600; margin-bottom: 10px; }
    #amount-input {
      width: 100%;
      padding: 12px;
      font-size: 1.2em;
      border: 1px solid #0A4879;
      border-radius: 5px;
      margin-bottom: 20px;
      box-sizing: border-box;
    }
    button {
      width: 100%;
      padding: 14px;
      font-size: 1.2em;
      background-color: #016FD0;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin-bottom: 10px;
    }
    button:hover { background-color: #0A4879; }
    footer { margin-top: 40px; font-size: 0.9em; color: #777; }
  </style>
</head>
<body>
  <header>
    <div class="logo-container">
      <img src="images/logo.jpg" alt="Dorothy Cole Logo" class="logo-img" />
      <div class="main-title">Secure Payment</div>
    </div>
  </header>

  <div id="mainContent">
    <div class="container">
      <label for="amount-input">Amount (USD): $</label>
      <input type="number" id="amount-input" value="100.00" min="1.00" step="0.01" required />

      <label for="email-input">Email:</label>
      <input type="email" id="email-input" placeholder="your.email@example.com" />

      <button id="startFlowBtn">Create Customer & Verify Bank</button>
      <button id="saveBankBtn" style="display:none;">Save Bank Info</button>
      <button id="payBtn" style="display:none;">Pay</button>
    </div>
  </div>

  <script type="text/javascript">
    const stripe = Stripe('pk_test_51RqI7CAtDFEhM4UVdqmZtq6zADc1RWJNZMQEslgTR0rJMze1MO6VTof0OOAtlwEQ9vwpZBIyEHaqLKAhmJAl6g9I00SbS1Vhts');
    let customerId = null;
    let paymentMethodId = null;
    let setupIntentClientSecret = null;

    // Utility: get URL params
    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        amount: params.get('amount'),
        email: params.get('email')
      };
    }

    // Function to start the flow
    async function startFlow() {
      const emailInput = document.getElementById('email-input');
      const amountVal = parseFloat(document.getElementById('amount-input').value);
      const email = emailInput.value.trim();

      if (!email) {
        alert('Please enter your email.');
        return;
      }

      // Step 1: Create Customer
      const resCreate = await fetch('/create-customer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email }),
      });
      const dataCreate = await resCreate.json();
      customerId = dataCreate.customerId;
      alert('Customer created: ' + customerId);

      // Step 2: Create Setup Intent
      const resSetup = await fetch('/create-setup-intent', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ customerId }),
      });
      const dataSetup = await resSetup.json();
      setupIntentClientSecret = dataSetup.clientSecret;

      // Step 3: Verify Bank Account using Stripe.js
      const elements = stripe.elements();
      const bank = elements.create('usBankAccount');
      bank.mount('#bank-element');

      const { setupIntent, error } = await stripe.confirmUsBankAccountPayment(
        setupIntentClientSecret,
        {
          payment_method: {
            us_bank_account: bank,
          },
        }
      );

      if (error) {
        alert(error.message);
        return;
      }
      if (setupIntent.status === 'succeeded') {
        // Save PaymentMethod ID
        paymentMethodId = setupIntent.payment_method;
        alert('Bank verified! Click "Save Bank Info" to store it.');
        document.getElementById('saveBankBtn').style.display = 'inline-block';
      }
    }

    // Save the verified bank info
    document.getElementById('saveBankBtn').onclick = async () => {
      if (!paymentMethodId || !customerId) {
        alert('Verify bank first!');
        return;
      }
      // Here you'd typically save paymentMethodId linked to customerId in your DB
      alert('Bank info saved!');
      document.getElementById('payBtn').style.display = 'inline-block';
    };

    // Make the payment
    document.getElementById('payBtn').onclick = async () => {
      const amountCents = Math.round(parseFloat(document.getElementById('amount-input').value) * 100);
      const email = document.getElementById('email-input').value.trim();
      if (!customerId || !paymentMethodId) {
        alert('Verify bank and save first!');
        return;
      }
      const resPay = await fetch('/charge', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ customerId, paymentMethodId, amount: amountCents }),
      });
      const dataPay = await resPay.json();
      if (dataPay.error) {
        alert('Payment failed: ' + dataPay.error);
      } else {
        alert('Payment successful! PaymentIntent ID: ' + dataPay.paymentIntentId);
      }
    };

    // Auto-start if URL params are present
    window.addEventListener('load', () => {
      const params = getUrlParams();
      if (params.amount) {
        document.getElementById('amount-input').value = parseFloat(params.amount).toFixed(2);
      }
      if (params.email) {
        document.getElementById('email-input').value = params.email;
        // Auto-start process
        startFlow();
      }
    });

    // Button to manually start the flow
    document.getElementById('startFlowBtn').onclick = startFlow;
  </script>
</body>
</html>